<style>
body{
  margin: 0;
}

.audio{
  position: absolute;
  top: 0;
  left: 0;
  z-index: 1;
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/98/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/2.0.2/TweenMax.min.js"></script>

<div id="webgl"></div>

<script>
class Audio { 
  constructor(){
    this.audio = this.createMedia();
    this.AudioContext = window.AudioContext || window.webkitAudioContext;
    this.audioCtx = new this.AudioContext();
    this.analyser = this.audioCtx.createAnalyser();
    this.analyser.smoothingTimeConstant = 0.3;
    this.track = this.audioCtx.createMediaElementSource(this.audio);
    
    this.connectAudio();
    this.getData = this.getData.bind(this);
  }
  
  createMedia(){
    let audio = document.createElement("audio");
    audio.crossOrigin = "anonymous";
    audio.src = "https://mojojohoe.github.io/Kinko/Public/WorldIsNotEnough.mp3";
    audio.controls = true;
    audio.style.width = 300 + "px";
    audio.className = "audio";
    document.body.appendChild(audio);
    return audio;
  }
  
  connectAudio(){
    this.track.connect(this.analyser);
    this.analyser.connect(this.audioCtx.destination);
  }
  
  getData(){
    let frequencyByteData = new Uint8Array(this.analyser.frequencyBinCount);
    this.analyser.getByteFrequencyData(frequencyByteData);
    return frequencyByteData;
  }
}

class Particles extends Audio{
  constructor(){
    super();
    this.canvas = document.getElementById("webgl");
    this.light = this.setLight();
    this.particles = this.setParticles();
    this.camera = this.setCamera();
    this.scene = this.setScene();
    this.renderer = this.setRenderer();
    
    this.update = this.update.bind(this);
    this.onResize = this.onResize.bind(this);
    
    this.canvas.appendChild(this.renderer.domElement);
    window.addEventListener("resize", this.onResize);
    TweenMax.ticker.addEventListener("tick", this.update);
  }
  
  setLight(){
    let light = new THREE.DirectionalLight("#ffffff", 1);
    return light;
  }
  
  setParticles(){
    let geo = new THREE.SphereGeometry(10, 50, 50);
    let pointsMaterial = new THREE.PointsMaterial({
      color: "#ffffff",
      size: 0.15
    });
    
    geo.vertices.forEach(vertice => {
      vertice.x += Math.random();
      vertice.y += Math.random();
      vertice.z += Math.random();
    })
    
    let mesh = new THREE.Points(geo, pointsMaterial);
    
    return mesh;
  }
  
  setCamera(){
    let camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 1000);
    camera.position.z = 30;
    camera.lookAt(new THREE.Vector3(0, 0, 0));
    return camera;
  }
  
  setScene(){
    let scene = new THREE.Scene();
    scene.add(this.light);
    scene.add(this.particles);
    return scene;
  }
 
  setRenderer(){
    let renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    return renderer;
  }
  
  onResize(){
    this.camera.aspect = window.innerWidth / window.innerHeight;
    this.camera.updateProjectionMatrix();
    this.renderer.setSize(window.innerWidth, window.innerHeight)
  }
  
  update(){
    this.particles.rotation.y += .001;
    let average = (this.getData().reduce((a, b) => a + b))/this.getData().length;
    TweenMax.to(this.particles.scale, .3, {x: (average * 0.005) + 0.5});
    TweenMax.to(this.particles.scale, .3, {y: (average * 0.005) + 0.5});
    TweenMax.to(this.particles.scale, .3, {z: (average * 0.005) + 0.5});
    this.particles.geometry.verticesNeedUpdate = true;
    this.renderer.render(this.scene, this.camera);
  } 
}

new Particles();
</script>